/*! fossil-core 2013-08-12 */
define("fossil",["underscore","backbone","jquery"],function(a,b,c){var d=function(a){"use strict";return a.Fossil||(a.Fossil={}),a.Fossil.Mixins||(a.Fossil.Mixins={}),a.Fossil}(this);return d.Deferred=function(a){return a.Deferred}(c),d.View=function(a,b){var c=b.View.extend({constructor:function(a){b.View.apply(this,arguments),a&&"undefined"!=typeof a.template&&(this.template=a.template)},render:function(){var b,c,d=a.toArray(arguments);return this.precompile&&(this.template=this.precompile(this.template)),b={},this.getViewData&&(b=this.getViewData()),c=this.template,this.renderHtml&&(c=this.renderHtml.apply(this,[b].concat(d))),this.$el.html(c),this}});return c}(a,b,d),d.Mixins.Deferrable=function(a,b,c){"use strict";function d(){this.deferred=new c,this.promises=[],this.uuid=f++,this.timeouts=[]}var e={timeout:"async process timed out",rejected:"some asynchronous process failed",missing_method:function(b){a.template("Promise has no `<%= method %>` method.",{method:b})}},f=0,g={waitFor:function(b,c){return this.isWaiting()||(this.async=new d,this.async.onStop=a.bind(function(){this.async=null},this)),this.async.enqueue(b,c),this},then:function(a,b,c){return this.isWaiting()?(this.async.then(a,b,c),this):(a&&a(),c&&c(),this)},thenWith:function(b,c,d,e){return this.then(c?a.bind(c,b):c,d?a.bind(d,b):d,e?a.bind(e,b):e)},abort:function(){return this.isWaiting()&&this.async.abort(),this},isWaiting:function(){return!!this.async&&!!this.async.deferred&&"pending"===this.async.deferred.state()}};return a.extend(d.prototype,{enqueue:function(a,b){b=this.ensureOptions(b),a.deferrableUuid=this.uuid,this.promises.push(a),b.timeout&&this.addTimeout(a,b.timeout),b.failFast?this.addFailFast(a):this.addFailSilently(a)},then:function(a,b,c){a&&this.deferred.done(a),b&&this.deferred.fail(b),c&&this.deferred.always(c)},ensureOptions:function(b){return a.extend({failFast:!0,timeout:!1},b||{})},addTimeout:function(a,b){if(!a.always)throw new Error(e.missing_method("always"));var c=setTimeout(function(){a.reject(e.timeout)},b);a.always(function(){c&&clearTimeout(c)}),this.timeouts.push(c)},addFailSilently:function(b){if(!b.always)throw new Error(e.missing_method("always"));b.always(a.bind(this.onAlways,this,b))},addFailFast:function(b){if(!b.done)throw new Error(e.missing_method("done"));if(b.done(a.bind(this.onDone,this,b)),!b.fail)throw new Error(e.missing_method("fail"));b.fail(a.bind(this.onFail,this,b))},onDone:function(a){this.isValidPromise(a)&&this.processAsyncReturn(a)},onFail:function(a,b){this.isValidPromise(a)&&this.reject(b)},onAlways:function(a){this.isValidPromise(a)&&this.processAsyncReturn(a)},reject:function(a){this.deferred.reject(a),this.deferred.reject.apply(this.deferred,[a].concat(this.promises)),this.stop()},processAsyncReturn:function(){var b=a.every(this.promises,function(a){return"pending"!==a.state()});if(!b)return this;var c=a.any(this.promises,function(a){return"resolved"!==a.state()});return c?this.reject(e.rejected):(this.deferred.resolve.apply(this.deferred,this.promises),this.stop(),void 0)},isValidPromise:function(a){return this.uuid===a.deferrableUuid},abort:function(b){return a.each(this.promises,function(b){b.abort&&a.isFunction(b.abort)&&b.abort()}),this.reject(b||e.aborted)},stop:function(){this.uuid=null,a.each(this.timeouts,function(a){a&&clearTimeout(a)}),this.onStop()}}),g}(a,d,d.Deferred),d.Mixins.Elementable=function(a){"use strict";var b={not_initialized:"The Elementable element is not initialized. Call setElement first."},c={setElement:function(b){return this.$el&&this.detachElement(),this.$el=a(b),this.trigger("elementable:attach",this),this},detachElement:function(){this.trigger("elementable:detach",this),this.$el=null},$:function(){if(!this.$el)throw new Error(b.not_initialized);return this.$el.find.apply(this.$el,arguments)}};return c}(c,d),d.Mixins.Fragmentable=function(a,b){"use strict";var c={unknown_fragment:b.template('No fragment available for "<%= id %>".')},d={fragments:{},initFragmentable:function(){this.options.fragments&&(this.fragments=b.extend(this.fragments,this.options.fragments))},getFragmentAncestor:function(){return this},ensureFragment:function(a){var b=this.fragments[a];if(!b)throw new Error(c.unknown_fragment({id:a}));return"object"==typeof b?b:(b=new b(this.getFragmentAncestor()),this.trigger("fragmentable:fragment:setup",b,a,this),b)},renderFragments:function(){var a=this;this.$("[data-fossil-fragment]").each(function(b,c){var d=c.getAttribute("data-fossil-fragment");a.renderFragment(d,a.$(c))}),this.trigger("fragmentable:render",this)},renderFragment:function(a,b){var c=this.ensureFragment(a);c.setElement(b),c.render(),this.trigger("fragmentable:fragment:render",c,a,this)},removeFragments:function(){var a=this;this.$("[data-fossil-fragment]").each(function(b,c){var d=c.getAttribute("data-fossil-fragment");a.removeFragment(d)}),this.trigger("fragmentable:remove",this)},removeFragment:function(a){var b=this.fragments[a];b&&b.$el&&(b.detachElement(),this.trigger("fragmentable:fragment:remove",b,a,this))}};return d}(d,a,b),d.Mixins.Layoutable=function(a,b,c){"use strict";function d(a,b){return"string"!=typeof b?!1:new i({template:b})}function e(a,b){return"function"!=typeof b||b.prototype.render?!1:new i({template:b})}function f(a,b){return b?!1:new i({template:a.$el.html()})}function g(a,b){return b instanceof c.View?b:!1}function h(a,b){return"function"==typeof b&&b.prototype.render?(b=new b({}),a.$el.append(b.$el),b):!1}var i=a.View,j={template:null,initLayoutable:function(){this.options&&"undefined"!=typeof this.options.template&&(this.template=this.options.template)},setupLayout:function(a){this.layout=d(this,a)||e(this,a)||f(this,a)||g(this,a)||h(this,a)||a,this.trigger("layout:setup",this)},renderLayout:function(){this.layout||this.setLayout(this.template,!0),this.attachLayout(),this.renderView?this.renderView(this.layout):this.layout.render(),this.trigger("layout:render",this)},attachLayout:function(){this.layout.setElement(this.$el)},removeLayout:function(){this.layout.setElement(null),this.$el.empty(),this.trigger("layout:remove",this)},setLayout:function(a,b){return this.layout&&(this.removeLayout(),this.layout=null),this.setupLayout(a),b?this.attachLayout():this.renderLayout(),this}};return j}(d,a,b),d.Mixins.Observable=function(a,b,c){"use strict";var d=["_listenerId","createPubSub"].concat(b.keys(c.Events)),e=b.extend({},c.Events,{registerEvents:function(){var a=b.extend({},b.result(this,"events"),b.result(this.options||{},"events")),c=this;b.each(a,function(a,d){b.isFunction(a)||(a=c[a]),c.listenTo(c,d,b.bind(a,c))})},createPubSub:function(a,c){var e={},f=this;if(b.each(d,function(a){e[a]=b.isFunction(f[a])?b.bind(f[a],f):f[a]}),!a)return e;var g=b.extend({},b.result(a,c),b.result(a.options||{},c));return b.each(g,function(c,d){b.isFunction(c)||(c=a[c]),f.listenTo(f,d,b.bind(c,a))}),e}});return e}(d,a,b),d.Mixins.Startable=function(){"use strict";var a={run:!1,start:function(){return this.run?!1:(this._firstStarted||(this._firstStart(),this._firstStarted=!0),this.thenWith(this,this._doStart,this._startError),void 0)},standby:function(){return this.run?(this._doStandby(),void 0):!1},stop:function(){return this._firstStarted?(this.standby(),this.thenWith(this,this._doStop,this._stopError),void 0):!1},_startError:function(a){throw a},_stopError:function(a){throw a},_firstStart:function(){this.trigger("start:first",this)},_doStart:function(){this.trigger("start",this),this.run=!0},_doStandby:function(){this.trigger("standby",this),this.run=!1},_doStop:function(){this._firstStarted=!1,this.trigger("stop",this)}};return a}(d),d.Service=function(a,b,c){"use strict";function d(a,b){return["service",a,b].join(":")}function e(a,c,d){return c=b.result(a.options,c),null!==c?c:b.result(a.options,d)}a.Services={};var f=function(a){this.options=b.extend({},this.options,a||{}),this.registerEvents(),this.initialize.apply(this,arguments)};return b.extend(f.prototype,a.Mixins.Observable,{exposedMethods:null,options:{expose:!1,link:!1,exposeToApplication:null,linkToApplication:null,exposeToModule:null,linkToModule:null,exposeToFragment:null,linkToFragment:null},initialize:function(){},activateApplication:function(a,c){var f=this;this.prefixEvent=b.bind(d,this,c),e(this,"exposeToApplication","expose")&&this.doExpose(a,c),e(this,"linkToApplication","link")&&this.undoLink(a,c),this.application=a.createPubSub(this,"applicationEvents"),this._doActivateApplication(a),b.each(a.getModule(),function(b){f.activateModule.call(f,b,a,c)}),this.listenTo(a,"module:connect",b.bind(this.activateModuleListener,this,c)),this.listenTo(a,"fragmentable:fragment:setup",b.bind(this.activateFragmentListener,this,c)),a.trigger(this.prefixEvent("ready"),this)},suspendApplication:function(a,c){var d=this;b.each(a.getModule(),function(b){d.suspendModule.call(d,b,a,c)}),e(this,"exposeToApplication","expose")&&this.undoExpose(a,c),e(this,"linkToApplication","link")&&this.undoLink(a,c),this.stopListening(),this.application=null,this._doSuspendApplication(a)},activateModule:function(a,c,d){a.services&&(e(this,"exposeToModule","expose")&&this.doExpose(a,d),e(this,"linkToModule","link")&&this.doLink(a,d),this._doActivateModule.apply(this,arguments),this.listenTo(a,"fragmentable:fragment:setup",b.bind(this.activateFragmentListener,this,d)),a.trigger(this.prefixEvent("ready"),this))},suspendModule:function(a,b,c){e(this,"exposeToModule","expose")&&this.undoExpose(a,c),e(this,"linkToModule","link")&&this.undoLink(a,c),this._doSuspendModule.apply(this,arguments)},activateModuleListener:function(a,b,c,d){this.activateModule(b,d,a)},activateFragment:function(a,c,d){a.services&&(e(this,"exposeToFragment","expose")&&this.doExpose(a,d),e(this,"linkToFragment","link")&&this.doLink(a,d),this._doActivateFragment.apply(this,arguments),this.listenTo(a,"fragmentable:fragment:setup",b.bind(this.activateFragmentListener,this,d)),a.trigger(this.prefixEvent("ready"),this))},suspendFragment:function(a,b,c){e(this,"exposeToFragment","expose")&&this.undoExpose(a,c),e(this,"linkToFragment","link")&&this.undoLink(a,c),this._doSuspendFragment.apply(this,arguments)},activateFragmentListener:function(a,b,c){this.activateFragment(b,c,a)},doLink:function(a,b){a[b]=this},undoLink:function(a,b){a[b]=null},doExpose:function(a){var c=this;b.each(this.exposedMethods,function(d){a[d]=b.bind(c[d],c)})},undoExpose:function(a){b.each(this.exposedMethods,function(b){a[b]=null})},_doActivateApplication:function(){},_doActivateModule:function(){},_doActivateFragment:function(){},_doSuspendApplication:function(){},_doSuspendModule:function(){},_doSuspendFragment:function(){}}),f.extend=function(){this.prototype.options;var a=c.Model.extend.apply(this,arguments);return a.prototype.options=b.extend({},this.prototype.options,a.prototype.options||{}),a},f}(d,a,b),d.Application=function(a,b,c,d){"use strict";function e(a){var b=c.extend({},a.services||{},a.options.services||{});a.services={},c.each(b,function(b,c){a.use(c,b)})}function f(a){var b=c.extend({},a.modules||{},a.options.modules||{});a.modules={},c.each(b,function(b,c){a.connect(c,b)})}var g={unknown_module:c.template('Unknown module at "<%- path %>".')},h=function(a){this.options=a||{},this.registerEvents(),e(this),this.initLayoutable(),this.initFragmentable(),f(this),this.initialize.apply(this,arguments)};return c.extend(h.prototype,a.Mixins.Observable,a.Mixins.Elementable,a.Mixins.Layoutable,a.Mixins.Fragmentable,a.Mixins.Deferrable,a.Mixins.Startable,{selector:"body",currentModule:null,template:'<div data-fossil-placeholder="module"></div>',initialize:function(){},connect:function(a,b){return c.isFunction(b)&&(b=new b),this.modules[a]=b,b.trigger&&b.trigger("connect",this,a),this.trigger("module:connect",b,a,this),this},getModule:function(a){if("undefined"==typeof a)return this.modules;if(this.modules[a])return this.modules[a];throw new Error(g.unknown_module({path:a}))},use:function(a,b){return c.isFunction(b)&&(b=new b),this.services[a]&&this.services[a].suspendApplication(this,a),b.activateApplication(this,a),this.services[a]=b,this.trigger("service:use",b,a,this),this},_doStart:function(){this.setElement(b(this.selector)),this.renderLayout(),this.renderFragments(),a.Mixins.Startable._doStart.apply(this,arguments)},switchModule:function(a){var b=this.currentModule!==a;if(b&&this.currentModule&&(this.trigger("module:standby",this.currentModule),this.currentModule.detachElement()),b){var c=this.$("[data-fossil-placeholder=module]");this.trigger("module:change",this.currentModule,a),a.setElement(c),a.thenWith(this,function(){this.trigger("module:start",a),this.currentModule=a})}}}),h.extend=d.Model.extend,h}(d,$,a,b),d.Module=function(a,b,c){"use strict";var d=function(a){this.options=a||{},"string"==typeof this.options.path&&(this.path=b.result(this.options,"path")),this.registerEvents(),this.initLayoutable(),this.initFragmentable(),this.initialize.call(this)};return b.extend(d.prototype,a.Mixins.Observable,a.Mixins.Elementable,a.Mixins.Layoutable,a.Mixins.Fragmentable,a.Mixins.Deferrable,a.Mixins.Startable,{applicationEvents:{},events:{},initialize:function(){},registerEvents:function(){a.Mixins.Observable.registerEvents.call(this),this.listenTo(this,"connect",b.bind(this.connectListener,this))},connectListener:function(a,c){this.application=a.createPubSub(this,"applicationEvents"),"string"!=typeof this.path&&(this.path=c),this.services=a.services,this.listenTo(this,"elementable:attach",b.bind(this.elementAttachListener,this,a)),this.listenTo(this,"elementable:detach",b.bind(this.elementDetachListener,this,a))},elementAttachListener:function(){this.start(),this.thenWith(this,this.render)},elementDetachListener:function(){this.standby()},render:function(){this.renderLayout(),this.renderFragments()},_doStandby:function(){a.Mixins.Startable._doStandby.apply(this,arguments),this.removeFragments(),this.removeLayout()}}),d.extend=c.Model.extend,d}(d,a,b),d.Fragment=function(c){var d=function(a,b){this.options=b||{},this.services={},this.path=a.path||"",this.ancestor=a.createPubSub(this,"ancestorEvents"),this.services=a.services,this.registerEvents(),this.initLayoutable(),this.initFragmentable(),this.initialize.apply(this,arguments)};return a.extend(d.prototype,c.Mixins.Observable,c.Mixins.Elementable,c.Mixins.Layoutable,c.Mixins.Fragmentable,c.Mixins.Deferrable,c.Mixins.Startable,{initialize:function(){},fagments:{},getFragmentAncestor:function(){return this.ancestor},registerEvents:function(){c.Mixins.Observable.registerEvents.call(this),this.listenTo(this,"elementable:attach",a.bind(this.start,this)),this.listenTo(this,"elementable:detach",a.bind(this.standby,this)),this.listenTo(this.ancestor,"standby",a.bind(this.standby,this)),this.listenTo(this.ancestor,"stop",a.bind(this.stop,this))},render:function(){return this.renderLayout(),this.renderFragments(),this.trigger("render"),this},remove:function(){return this.trigger("remove"),this.removeFragments(),this.removeLayout(),this}}),d.extend=b.Model.extend,d}(d),d.Services.Routing=function(a,b,c){"use strict";function d(a,b){return[b||"",a||""].join("")}var e=a.Service.extend({options:{prefix:"",navigate:{trigger:!0}},initialize:function(){this.router=new c.Router,this.registerRoutesFor(this)},registerRoutesFor:function(a,c){var e=this,f=b.extend(a.routes||{},a.options.routes||{});c=d(c,this.options.prefix),b.each(f,function(f,g){e.router.route(d(g,c),b.bind(e.routeListener,e,a,f))})},_doActivateApplication:function(a){this.registerRoutesFor(a),this.listenTo(a,"router:navigate",b.bind(this.navigate,this)),this.listenTo(a,"start",b.bind(this.startListener,this))},_doActivateModule:function(a,c){var e=this,f=d(a.path,this.options.prefix);b.each(a.routes||{},function(g,h){e.router.route(d(h,f),g,b.bind(e.moduleRouteListener,e,c,a,g))})},_doSuspendApplication:function(){c.history.stop(),this.stopListening()},_doSuspendModule:function(){},startListener:function(){c.history.start(this.options.history)},moduleRouteListener:function(a,c,d){var e=this,f=b.tail(b.tail(b.tail(arguments)));a.switchModule(c),c.then(function(){e._callRoute(c,c,d,f)})},routeListener:function(a,c){var d=this,e=b.tail(b.tail(arguments));a.then?a.then(function(){d._callRoute(d.application,a,c,e)}):d._callRoute(d.application,a,c,e)},navigate:function(a,c){var d=b.extend({},this.options.navigate||{},c||{});this.router.navigate.call(this.router,a,d)},_callRoute:function(a,c,d,e){if(b.isFunction(d))d.apply(c,e);else if(b.isFunction(c[d]))c[d].apply(c,e);else{if(!b.isString(d))throw new Error("Invalid route definition");a.trigger.apply(c,[d].concat(e))}}});return e}(d,a,b),d.Services.Session=function(a,b,c){"use strict";function d(){throw new Error}var e=["get","set","has"],f=a.Service.extend({options:{expose:!0,defaults:{}},_doActivateApplication:function(){var a=this;this.model=new c.Model(this.options.defaults||{}),b.each(e,function(c){a[c]=b.bind(a.model[c],a.model)})},_doSuspendApplication:function(){var a=this;this.model=null,b.each(e,function(b){a[b]=d})}});return b.each(e,function(a){f.prototype[a]=d}),f}(d,a,b),d});